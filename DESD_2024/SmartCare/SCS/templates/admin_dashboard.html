{% extends 'index.html' %}
{% block content%}
{% include 'CheckSession.html' %}
<h2>Dashboard</h2>
<div>
    {% if user.is_authenticated %}
    <a href="DisplayPatients">Display patients</a>
{% endif %}
  </div>

<table class="table table-hover">
    <thead>
        <tr class="table-info">
            <th>Patient name</th>
            <th> Age</th>
            <th>Known allergies</th>
            <th>Private billing</th>
            <th>Details</th>

        </tr>
    </thead>
    <tbody>
{% for patient in patients %}
<tr class="table-dark" data-row-id="{{patient.id}}">
<td>{{ patient.user_profile }}</td>
<td>{{ patient.age }}</td>
<td>{{ patient.allergies }}</td>
<td>{{ patient.isPrivate }}</td>
<td><button type="button" class="btn btn-primary"  data-bs-toggle="modal" data-bs-target="#modal1{{patient.user_profile}}">History</button>
<button type="button" class="btn btn-primary"  data-bs-toggle="modal" data-bs-target="#modal2{{patient.user_profile}}">Update</button>
<button type="button" class="btn btn-primary"  data-bs-toggle="modal" data-bs-target="#modal3{{patient.user_profile}}">Delete</button></td>
</tr>
   
{% endfor %}
</tbody>
</table>
{% for patient in patients %}

<div class="modal fade" id="modal1{{ patient.user_profile }}" tabindex="-1" role="dialog" aria-labelledby="modal{{ patient.user_profile}}Label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal{{patient.user_profile}}Label">Details for {{ patient.user_profile }}</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table table-hover">
                    <thead>
                        <tr class="table-info">
                            <th>Appointemnt </th>
                            <th> Date</th>
                            <th>Service</th>
                            <th>Description </th>
                            <th>Note</th>
                        </tr>
                    </thead>
                    <tbody>
               
                    {% for appt in appointments %}
                   
                    {% if appt.patient.user_profile == patient.user_profile %}
                  
                 
                
                       
                    <tr class="table-dark" data1-row-id="{{patient.id}}">
                      
                        <td>{{appt.appointmentID}}</td>
                        <td>{{ appt.date }}</td>
                        <td>{{ appt.service}}</td>
                        <td>{{ appt.description }}</td>
                        <td>{{ appt.notes }}</td>
    
                    
                    {% endif %}
                    {% endfor %}
                </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>




<div class="modal fade" id="modal3{{ patient.user_profile }}" tabindex="-1" role="dialog" aria-labelledby="modal{{ patient.user_profile }}Label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal{{ patient.user_profile }}Label">Details of {{ patient.user_profile }}</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
             <p>Are you sure you would like to delete the row? </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" data-id="{{ patient.id }}" data-user-profile-id="{{ patient.user_profile.id }}" class="delete-button btn btn-danger " >Delete</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal2{{ patient.user_profile }}" tabindex="-1" role="dialog" aria-labelledby="modal{{ patient.id }}Label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal2{{ patient.user_profile }}Label">Details of {{ patient.user_profile }} </h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form class="updateForm" id="updateForm" data-button-id="{{ patient.id}}"  method="POST">
                    {% csrf_token %}
                    <input type="text" name="Name" value="{{ patient.user_profile }}">
                    <input type="text" name="Age" value="{{ patient.age}}">
                    <input type="text" name="Allergies" value="{{ patient.allergies }}">
                    <select name="Status">
                        <option value= "True" {% if patient.isPrivate %}selected{% endif %}>Private</option>
                        <option value=  "False" {% if not patient.isPrivate %}selected{% endif %}>Public</option>
                    </select>

                
                   
                    <button type="submit" data-id="{{ patient.id }}"  class="update-button btn btn-warning" >Update</button>
                </form>
            </div>
        
             
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
             </div>
       
           
        </div>
    </div>
</div>

{% endfor %}


<script>
   
    
    const deleteButtons = document.querySelectorAll('.delete-button');
    deleteButtons.forEach(button => {
      button.addEventListener('click', () => {
        alert('hi')
        const id = button.dataset.id;
        const userProfileId = button.dataset.userProfileId;
        alert(id)
        alert(userProfileId)
        var token = "{{ csrf_token }}";
        console.error(token);

        const rowElement = document.querySelector(`tr[data-row-id="${id}"]`);
        alert(rowElement)
        
        
        
        
        fetch(`/delete/${id}`, {
          method: 'DELETE',
          headers: {
            'X-CSRFToken': token},
            
        })
        .then(response => {
          if (response.ok) {
            // Row deleted successfully, updating the UI
            rowElement.remove();
            const modal = button.closest('.modal');
            const modalInstance = bootstrap.Modal.getInstance(modal);
            modalInstance.hide();
            alert('Row has been deleted');
          } else {
            alert('we here')
            response.text().then(errorMessage => {
            alert('Error: ' + errorMessage);
            });
            // Handle error response
            console.error('Failed to delete row');
          }
        })
        .catch(error => {
          // Handle network or other errors
          console.error('Failed to delete row', error);
          alert('Failed to delete row: ' + error.message);
        });
      });
    });
    </script>
   
   <script>
    const forms = document.querySelectorAll('.updateForm');
    forms.forEach(form => {
      form.addEventListener('submit', function(event) {
        event.preventDefault();
        var submitButton = event.submitter;
      
      // Get the ID of the submit button
        var id = submitButton.dataset.id;
        alert(id)
        
        var formData =  new FormData(document.querySelector(`form[data-button-id="${id}"]`));
        formData.append('id', id);
        alert(formData)
        var token = "{{ csrf_token }}";
      
      
        fetch('/update-patient/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': token
          },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          
          if (data.success) {
            // Handle success case
            alert('Model row updated successfully!');
            var updatedRow = document.querySelector(`tr[data-row-id="${id}"]`);
            updatedRow.querySelector('td:nth-child(1)').textContent = data.data.name;
            updatedRow.querySelector('td:nth-child(2)').textContent = data.data.age;
    
            updatedRow.querySelector('td:nth-child(3)').textContent = data.data.allergies;
            updatedRow.querySelector('td:nth-child(4)').textContent = data.data.status;

            
        
    
          } else {
            // Handle error case
            alert('Failed to update the model row: ' + data.message);
          }
        })
        .catch(error => {
          // Handle error case
          alert('Failed fetch error ' + error);
        });
      });
    });
    
    
    </script>





{% endblock %}