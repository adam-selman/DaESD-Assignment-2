{% extends 'dashboards.html' %}
{% block content%}
{% include 'CheckSession.html' %}
<div class="container">
  <div class="row">
    <div class="col-md-6">
      <h2>Book Appointment</h2>
      <p>Book an appointment with a doctor or nurse</p>
      <form id ="patient-booking-form" method="post">
        {% csrf_token %}
        <label for="service">Service: </label>
        <div class="form-group">
          <select id="service" name="service" class="form-control" required>
            <option selected disabled hidden>Select a service</option>
            {% for service_id, service_name, service_duration in services %} 
              <option value="{{service_id}}">{{ service_name }}</li> 
            {% endfor %} 
          </select>
        </div>
        <br>
        <div class="form_group">
          <label for="bookingDate" id="bookingDateLabel">Date: </label>
          <input id="bookingDate" type="date" name="bookingDate" class="form-control" disabled>
        </div>
        <br>
        <div class="form_group">
          <label for="practitioner" id="practitionerLabel"  >Doctor/Nurse: </label>
          <select id="practitioner" name="practitioner" class="form-control" required disabled>
            <option selected disabled hidden>Select a Practitioner</option>
          </select>
        </div>  
        <br>
        <div class="form_group">
          <label for="timeSlot"  id="timeSlotLabel">Time Slot: </label>
          <select id="timeSlot" name="timeSlot" class="form-control" required disabled>
            <option selected disabled hidden>Select a Time Slot</option>
          </select>
        </div>  
        <br>
        <textarea name="reason" id="reason" class="form-control" rows="3" placeholder="Reason for appointment"></textarea>
        <br>
        <button class="btn btn-primary">Book Appointment</button>
    </form>
    </div>
  </div>
</div>

  
<script>

// Adding event listener that listens for changes in the service select element
document.getElementById("service").addEventListener("change", function (e) {
  e.preventDefault();
  bookingDate = document.getElementById("bookingDate");
  practitionerSelect = document.getElementById("practitioner");
  timeSlotSelect = document.getElementById("timeSlot");
  if (e.target.value == "") {
    var bookingDate = document.getElementById('bookingDate');
    var bookingDateLabel = document.getElementById('bookingDateLabel');
    bookingDate.disabled = true;
    bookingDate.innerHTML = createSelectPlaceholderElement("Select a Date");
    bookingDate.style.backgroundColor = "red"
    practitionerSelect.disabled = true;
    practitionerSelect.innerHTML = createSelectPlaceholderElement("Select a Practitioner");
    timeSlotSelect.disabled = true;
    timeSlotSelect.innerHTML = createSelectPlaceholderElement("Select a Time Slot");
    document.getElementById('practitionerLabel').hidden = true;
    
    return;
  }
  else if (bookingDate.value !== "" && bookingDate.disabled === false) {
    getPractitionersByDayAndService(e.target, bookingDate)
    timeSlotSelect.disabled = true;
    populateTimeSlots([]);
  }
  else{
  var bookingDate = document.getElementById('bookingDate');
  var bookingDateLabel = document.getElementById('bookingDateLabel');

  bookingDate.disabled = false;
  }
  
 });

// Adding event listener that listens for changes in the bookingDate input element
document.getElementById("bookingDate").addEventListener("change", function (e) {
  e.preventDefault();
  if (e.target.value == "") {
    var practitionerSelect = document.getElementById('practitioner');
    practitionerSelect.disabled = true;
    practitionerSelect.innerHTML = createSelectPlaceholderElement("Select a Date");
    document.getElementById('practitionerLabel').hidden = true;
  }
  else{
    var service = document.getElementById('service');
    getPractitionersByDayAndService(service, e.target);
  }
  return;

});

// Adding event listener that listens for changes in the practitioner input element
document.getElementById("practitioner").addEventListener("change", function (e) {
  e.preventDefault();
  if (e.target.value !== "") {
    var bookingDate = document.getElementById('bookingDate');
    getTimeSlotsByDayAndPractitioner(bookingDate, e.target);
  }
  
});



/**
 * Method to populate the practitioners select element with available practitioners
 * @param {Array} practitioners - The practitioners to be populated
 */
function populatePractitioners(practitioners) {
  var practitionerSelect = document.getElementById('practitioner');
  practitionerSelect.innerHTML = "";
  
  // creating placeholder for selecting a practitioner
  placeholder_option = createSelectPlaceholderElement("Select a Practitioner")
  practitionerSelect.appendChild(placeholder_option);

  practitioners.doctors.forEach(doctor => {
    var option = document.createElement('option');
    option.value = doctor[1];
    option.text = doctor[0];
    practitionerSelect.appendChild(option);
  });

  practitioners.nurses.forEach(nurse => {
    var option = document.createElement('option');
    option.value = nurse[1];
    option.text = nurse[0];
    practitionerSelect.appendChild(option);
  });
}

/**
 * Method to populate the time slots select element with available time slots
 * @param {Array} timeSlots - The time slots to be populated
 */
function populateTimeSlots(timeSlots) {
  var timeSlotSelect = document.getElementById('timeSlot');
  timeSlotSelect.innerHTML = "";

  // creating placeholder for selecting a practitioner
  placeholder_option = createSelectPlaceholderElement("Select a Time Slot")
  timeSlotSelect.appendChild(placeholder_option);
  
  timeSlots.forEach(timeSlot => {
    var option = document.createElement('option');
    option.value = timeSlot;
    option.text = timeSlot;
    timeSlotSelect.appendChild(option);
  });

}

/**
 * Method to get practitioners by day and service when service and date selected
 * @param {HTMLSelectElement} service - The select element for the service
 * @param {HTMLInputElement} bookingDate - The input element for the booking date
 */
function getPractitionersByDayAndService(service, bookingDate) {
  // Create a FormData object and append the date value
  var formData = new FormData();
  formData.append("bookingDate", bookingDate.value);
  formData.append("service", service.value);
  var token = "{{ csrf_token }}" ;
  fetch('get_practitioners_by_day_and_service', {
    method: 'POST',
    headers: {
            'X-CSRFToken': token
            },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      populatePractitioners(data.practitioners);
      document.getElementById('practitioner').disabled = false;
    } else {
      
      alert(data.error);
    }
  });
}

/**
 * Method to get time slots by day and practitioner when date and practitioner selected
 * @param {HTMLInputElement} bookingDate - The input element for the booking date
 * @param {HTMLSelectElement} practitioner - The select element for the practitioner
 */
function getTimeSlotsByDayAndPractitioner(bookingDate, practitioner) {
  // Create a FormData object and append the date value
  var formData = new FormData();
  formData.append("bookingDate", bookingDate.value);
  formData.append("practitioner", practitioner.value);
  var token = "{{ csrf_token }}" ;
  fetch('get_time_slots_by_day_and_practitioner', {
    method: 'POST',
    headers: {
            'X-CSRFToken': token
            },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      populateTimeSlots(data.timeSlots);
      document.getElementById('timeSlot').disabled = false;
    } else {
      
      alert(data.error);
    }
  });
}


// Adding event listener that submits the form when the submit button is clicked
document.getElementById("patient-booking-form").addEventListener("submit", function (e) {
   e.preventDefault();
   makePatientAppointmentBooking(this);
});


/**
 * Method to make a patient appointment booking
 * @param {HTMLFormElement} form - The form element to be submitted
 */
function makePatientAppointmentBooking(form) {
    var formData = new FormData(form);
    var token = "{{ csrf_token }}" ;

    if (formData.get('bookingDate') === "") {
      alert("Please select a date");
      return;
    }

    else if (formData.get('practitioner') === "") {
      alert("Please select a practitioner");
      return;
    }

    else if (formData.get('service') === "") {
      alert("Please select a service");
      return;
    }

    else if (formData.get('timeSlot') === "") {
      alert("Please select a time slot");
      return;
    }

    fetch('patient_appointment_booking', {
    method: 'POST',
    headers: {
            'X-CSRFToken': token
            },
  
  body: formData
})
.then(response => response.json())
.then(data => {
  if (data.success) {
    // show success message
    // refresh page
    alert('Appointment booked successfully');

    // resetting form fields
    service = document.getElementById('service')
    service.value = createSelectPlaceholderElement("Select a Service");

    bookingDate = document.getElementById('bookingDate')
    bookingDate.value = createSelectPlaceholderElement("Select a Date");
    bookingDate.disabled = true;

    practitionerSelect = document.getElementById('practitioner')
    practitionerSelect.value = createSelectPlaceholderElement("Select a Practitioner");
    practitionerSelect.disabled = true;

    timeSlotSelect = document.getElementById('timeSlot')
    timeSlotSelect.value = createSelectPlaceholderElement("Select a Time Slot");
    timeSlotSelect.disabled = true;

    reason = document.getElementById('reason').value = "";    

  } else {
    
    alert(data.error);
  }
});

}

/**
 * Method to create a placeholder option element for a select element
 * @param {string} placeholderText - The text to be displayed as the placeholder
 * @returns {HTMLOptionElement} - The placeholder option element
 */
function createSelectPlaceholderElement(placeholderText) {
  var placeholder_option = document.createElement('option');
  placeholder_option.text = placeholderText;
  placeholder_option.selected = true;
  placeholder_option.disabled = true;
  placeholder_option.hidden = true;

  return placeholder_option;
}

</script>

{% endblock %}