{% extends 'index.html' %}
{% block content%}
<p>patient page</p>

<form id ="patient-booking-form" method="post">
    {% csrf_token %}
    <label>Booking Date</label>
    <input id="bookingDate" type="date" name="bookingDate">
    <br>
    <label hidden="true" id="practitionerLabel" >Doctor/Nurse</label>
    <select id="practitioner" name="practitioner" hidden="true">
    
    </select>
    <br>
      
    <button>Book Appointment</button>
</form>

<script>

document.getElementById("bookingDate").addEventListener("change", function (e) {
   e.preventDefault();
   getPractitioners(e.target);
 });

function populatePracticioners(practitioners) {
  var practitionerSelect = document.getElementById('practitioner');
  practitionerSelect.innerHTML = "";
  
  practitioners.doctors.forEach(doctor => {
    var option = document.createElement('option');
    option.value = doctor[1];
    option.text = doctor[0];
    practitionerSelect.appendChild(option);
  });

  practitioners.nurses.forEach(nurse => {
    var option = document.createElement('option');
    option.value = nurse[1];
    option.text = nurse[0];
    practitionerSelect.appendChild(option);
  });
}

 function getPractitioners(form_input) {
  // Create a FormData object and append the date value
    var formData = new FormData();
    formData.append("bookingDate", form_input.value);
  var token = "{{ csrf_token }}" ;
  fetch('get_practitioners', {
    method: 'POST',
    headers: {
            'X-CSRFToken': token
            },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log(data.practitioners);
      populatePracticioners(data.practitioners);
      document.getElementById('practitioner').hidden = false;
      document.getElementById('practitionerLabel').hidden = false;
    } else {
      
      alert(data.error);
    }
  });
}

 function makePatientAppointmentBooking(form) {
    var formData = new FormData(form);
    var token = "{{ csrf_token }}" ;

    if (formData.get('bookingDate') === "") {
      alert("Please select a date");
      return;
    }

    else if (formData.get('practitioner') === "") {
      alert("Please select a practitioner");
      return;
    }

    fetch('patient_appointment_booking', {
    method: 'POST',
    headers: {
            'X-CSRFToken': token
            },
  
  body: formData
})
.then(response => response.json())
.then(data => {
  if (data.success) {
    // show success message
    // refresh page
    alert(data.success);
    alert(data.bookingDate);

  } else {
    
    alert(data.error);
  }
});

}

</script>

{% endblock %}