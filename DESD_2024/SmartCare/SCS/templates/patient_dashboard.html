{% extends 'index.html' %}
{% block content%}
{% include 'CheckSession.html' %}
{% load static %}

<script src="{% static 'js/patient_dashboard.js' %}"></script>
<br>
<h1>Welcome {{ user.first_name }}</h1>
<hr>

<div class="container">
  {% if future_appointments %}
    <div class="row">
      <div class="col-md-12">
        <h2>Upcoming Appointments</h2>
        <table class="table">
          <thead class="table-info">
            <tr class="table-info">
              <th>Date</th>
              <th>Service</th>
          </tr>
          </thead>
          <tbody>
            {% for service_name, appointment_date, appointment_time, appointmentID in future_appointments %}

            <tr class="table-dark">
            <td>{{appointment_time}} on {{appointment_date}}</td>
            <td>{{service_name}}</td>
            {% endfor %}
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    {% else %}
    <div class="row">
      <div class="col-md-12">
        <h2>Upcoming Appointments</h2>
        <p>No appointments booked.</p>
      </div>
    </div>

  {% endif %}
</div>

<br>

<div class="container">
  {% if past_appointments %}
    <div class="row">
      <div class="col-md-12">
        <h2>Appointment History</h2>
        <table class="table">
          <thead class="table-info">
            <tr class="table-info">
              <th>Date</th>
              <th>Service</th>
          </tr>
          </thead>
          <tbody>
            {% for service_name, appointment_date, appointment_time, appointmentID in past_appointments %}

            <tr class="table-dark">
            <td>{{appointment_time}} on {{appointment_date}}</td>
            <td>{{service_name}}</td>
            {% endfor %}
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  
  {% else %}
    <div class="row">
      <div class="col-md-12">
        <h2>Appointment History</h2>
        <p>No past appointments</p>
      </div>
    </div>

  {% endif %}


</div>

<br>

<div class="container">
  <div class="row">
    {% if invoices %}
    <div class="col-md-12">
      <h2>My Invoices</h2>
      <p>View your issued invoices</p>
      <table class="table">
        <thead class="table-info">
          <tr class="table-info">
            <th >Service</th>
            <th>Amount</th>
            <th>Date Issued</th>
            <th>Invoice</th>
            <th>Payment Status</th>
          </tr>
        </thead>
        <tbody>
          {% for service_name, amount, issue_date, invoice_id, status in invoices %}
            <tr class="table-dark">
              <td>{{service_name}}</td>
              <td>Â£{{amount}}</td>
              <td>{{issue_date}}</td>
              <td>
                <a href="generate_invoice?invoiceID={{invoice_id}}">Download Invoice</a></td>
              <td>{% if status == 1 %}
                      Paid
                  {% elif status == 0 %}
                      Awaiting Payment
                  {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="row">
      <div class="col-md-12">
        <h2>Invoices</h2>
        <p>No invoices to display</p>
      </div>
    </div>

  {% endif %}
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      {% if historic_prescriptions %}
      <h2>Historic Prescriptions</h2>
      <table class="table table-hover">
        <thead>
          <tr class="table-info">
            <th>Medication</th>
            <th>Quantity</th>
            <th>Issue Date</th>
            <th>Practitioner</th>
          </tr>
        </thead>
        <tbody>
          {% for prescription in historic_prescriptions %}
          {% if prescription.approved %}
          <tr class="table-dark">
            <td>{{ prescription.medication.name }} {{ prescription.dosage }}</td>
            <td>{{ prescription.quantity }}</td>
            <td>{{ prescription.issueDate }}</td>
            <td>
              {% if not prescription.doctor %}
              {{ prescription.nurse }}
              {% else %}
              {{ prescription.doctor }}
              {% endif %}
            </td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="row">
        <div class="col-md-12">
        <h2>Historic Prescriptions</h2>
        <p>No past prescriptions</p>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="container">
  {% if historic_prescriptions %}
  <h2>Repeatable Prescriptions</h2>
  <table class="table table-hover">
    <thead>
      <tr class="table-info">
        <th>Patient name </th>
        <th>Medication</th>
        <th>Quantity</th>
        <th>Issue Date</th>
        <th>Request Before</th>
        <th>Request Repeat</th>
      </tr>
    </thead>
    <tbody>
      {% for prescription in historic_prescriptions %}
      {% if prescription.repeatable and prescription.approved %}
      <tr class="table-dark">
        <td>{{ prescription.patient }}</td>
        <td>{{ prescription.medication.name }} {{ prescription.dosage }}</td>
        <td>{{ prescription.quantity }}</td>
        <td>{{ prescription.issueDate }}</td>
        <td>{{ prescription.reissueDate }}</td>
        <td>
          <form action="{% url 'requestRepeatPrescription' %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="prescription_id" value="{{ prescription.prescriptionID }}">
            <button type="submit" class="btn btn-primary">Request Repeat</button>
          </form>
        </td>
      </tr>
      {% endif %}
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="row">
    <div class="col-md-12">
      <h2>Repeatable Prescriptions</h2>
      <p>No prescriptions to display</p>
    </div>
  {% endif %}

</div>

<div class="container">
  {% if historic_prescriptions %}
  <h2>Pending Prescription Requests</h2>
  <table class="table table-hover">
    <thead>
      <tr class="table-info">
        <th>Patient name </th>
        <th>Medication</th>
        <th>Quantity</th>
      </tr>
    </thead>
    <tbody>
      {% for prescription in historic_prescriptions %}
      {% if prescription.repeatable and not prescription.approved %}
      <tr class="table-dark">
        <td>{{ prescription.patient }}</td>
        <td>{{ prescription.medication.name }} {{ prescription.dosage }}</td>
        <td>{{ prescription.quantity }}</td>
      </tr>
      {% endif %}
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="row">
    <div class="col-md-12">
      <h2>Pending Prescription Requests</h2>
      <p>No pending prescription requests</p>
    </div>
  {% endif %}
</div>

<br>

<hr>
<div class="container">
  <div class="row">
    <div class="col-md-10">
      <h2>Book Appointment</h2>
      <p>Book an appointment with a doctor or nurse</p>
      <form id="patient-booking-form" method="post">
        {% csrf_token %}
        <label for="service">Service: </label>
        <div class="form-group">
          <select id="service" name="service" class="form-control" required>
            <option selected disabled hidden>Select a service</option>
            {% for service_id, service_name, service_duration in services %}
            <option value="{{service_id}}">{{ service_name }}</li>
              {% endfor %}
          </select>
        </div>
        <br>
        <div class="form_group">
          <label for="bookingDate" id="bookingDateLabel">Date: </label>
          <input id="bookingDate" type="date" name="bookingDate" class="form-control" disabled>
        </div>
        <br>
        <div class="form_group">
          <label for="practitioner" id="practitionerLabel">Doctor/Nurse: </label>
          <select id="practitioner" name="practitioner" class="form-control" required disabled>
            <option selected disabled hidden>Select a Practitioner</option>
          </select>
        </div>
        <br>
        <div class="form_group">
          <label for="timeSlot" id="timeSlotLabel">Time Slot: </label>
          <select id="timeSlot" name="timeSlot" class="form-control" required disabled>
            <option selected disabled hidden>Select a Time Slot</option>
          </select>
        </div>
        <br>
        <textarea name="reason" id="reason" class="form-control" rows="3"
          placeholder="Reason for appointment"></textarea>
        <br>
        <button class="btn btn-primary">Book Appointment</button>
      </form>
    </div>
  </div>
</div>


<script>

  document.addEventListener('DOMContentLoaded', function () {
    setDatePickerMinDateNow("bookingDate");
});

// Adding event listener that listens for changes in the service select element
document.getElementById("service").addEventListener("change", function (e) {
  e.preventDefault();
  bookingDate = document.getElementById("bookingDate");
  practitionerSelect = document.getElementById("practitioner");
  timeSlotSelect = document.getElementById("timeSlot");
  if (e.target.value == "") {
    var bookingDate = document.getElementById('bookingDate');
    var bookingDateLabel = document.getElementById('bookingDateLabel');
    bookingDate.disabled = true;
    bookingDate.innerHTML = createSelectPlaceholderElement("Select a Date");
    bookingDate.style.backgroundColor = "red"
    practitionerSelect.disabled = true;
    practitionerSelect.innerHTML = createSelectPlaceholderElement("Select a Practitioner");
    timeSlotSelect.disabled = true;
    timeSlotSelect.innerHTML = "";
    timeSlotSelect.add(createSelectPlaceholderElement("Select a Time Slot"));
    document.getElementById('practitionerLabel').hidden = true;
    

    }
    else if (bookingDate.value !== "" && bookingDate.disabled === false) {
      getPractitionersByDayAndService(e.target, bookingDate)
      timeSlotSelect.disabled = true;
      populateTimeSlots([]);
    }
    else {
      var bookingDate = document.getElementById('bookingDate');
      var bookingDateLabel = document.getElementById('bookingDateLabel');

      bookingDate.disabled = false;
    }
  });

  // Adding event listener that listens for changes in the bookingDate input element
  document.getElementById("bookingDate").addEventListener("change", function (e) {
    e.preventDefault();
    if (e.target.value === "") {
      var practitionerSelect = document.getElementById('practitioner');
      practitionerSelect.disabled = true;
      practitionerSelect.innerHTML = createSelectPlaceholderElement("Select a Date");
      document.getElementById('practitionerLabel').hidden = true;
      var timeSlotSelect = document.getElementById('timeSlot');
      timeSlotSelect.disabled = true;
      timeSlotSelect.innerHTML = "";
      timeSlotSelect.add(createSelectPlaceholderElement("Select a Time Slot"));
    }
    else {
      var timeSlotSelect = document.getElementById('timeSlot');
      timeSlotSelect.disabled = true;
      timeSlotSelect.innerHTML = "";
      timeSlotSelect.add(createSelectPlaceholderElement("Select a Time Slot"));
      var service = document.getElementById('service');
      getPractitionersByDayAndService(service, e.target);
    }
    return;

  });

  // Adding event listener that listens for changes in the practitioner input element
  document.getElementById("practitioner").addEventListener("change", function (e) {
    e.preventDefault();
    if (e.target.value !== "") {
      var bookingDate = document.getElementById('bookingDate');
      getTimeSlotsByDayAndPractitioner(bookingDate, e.target);
    }

  });


  // Adding event listener that submits the form when the submit button is clicked
  document.getElementById("patient-booking-form").addEventListener("submit", function (e) {
    e.preventDefault();
    makePatientAppointmentBooking(this);
  });

</script>



{% endblock %}